<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <title>14:31 Monday SMART APP</title>
    <link rel='stylesheet' type='text/css' href='./src/css/example-smart-app.css'>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>    
    <script src='./lib/fhir-client.js'></script>
    
    <script type="text/javascript">
    </script>
    
    <script  type="text/javascript">

	"use strict";
	$(window).load(function(){
		var resource = {"resourceType":"MedicationStatement","contained":[{"resourceType":"Medication","id":"123","code":{"text":"FHIR Test Medication"}}],
"patient":{"reference":"Patient/4342008"},"status":"active","medicationReference":{"reference":"#123"},
"dosage":[{"timing":{"code":{"coding":[{"system":"http://hl7.org/fhir/v3/vs/GTSAbbreviation","code":"BID"}],"text":"BID"}},
"quantityQuantity":{"value":60.0,"units":"mg","system":"http://unitsofmeasure.org","code":"mg"}}]};
		
		$("textarea#textWriteLog").val( JSON.stringify(resource,null,2) );
		$("textarea#textResourceLog").val( "Observation" );
	});	
      
	// 1 - Retrieve the Patient in the context
	$(document).on("click", "#buttonRetrieve", function(event){
		event.stopPropagation();

		$("textarea#textRetrieveLog").append( "Starting..." );
		console.log( "Starting..." );

		// Preliminary step - Creating a deferred object for a set of enhancements to the way to use callbacks.
		this.def = $.Deferred();
		this.def.done(function(){
			$("textarea#textRetrieveLog").append("====== DONE ======");
			console.log( "====== DONE ======" );
		});

		// 1. Initializing the client
		// Before you are able to run any operations against the FHIR API using the JS client, you will need to initialize it first.
		FHIR.oauth2.ready(onReady, onError);
		$("textarea#textRetrieveLog").append("window.FHIR: " + JSON.stringify(window.FHIR));
		console.log( "window.FHIR: " + JSON.stringify(window.FHIR,null,2) );
        
		// The deferred.promise() method allows an asynchronous function to prevent other code from interfering with the 
		// progress or status of its internal request.
		$("textarea#textRetrieveLog").append("Completed");
		console.log( "Completed" );

		return this.def.promise();

	}); // on("click #buttonRetrieve


	// 2 - Write a resource for the Patient in context
	$(document).on("click", "#buttonWrite", function(event){
		event.stopPropagation();
		
		console.log( "Writing the MedicationStatement resource" );
		
		// Preliminary step - Creating a deferred object for a set of enhancements to the way to use callbacks.
		//var def = $.Deferred();
		//def.done(function(){
		//	$("textarea#textWriteLog").append("====== DONE ======");
		//	console.log( "====== DONE WRITE ======" );
		//});
		
		FHIR.oauth2.ready(function(smart){

			var resWrite = $("textarea#textWriteLog").val();
			// Chaning from smart.patient.api.create to smart.api.create
			smart.patient.api.create({resource: resWrite}).done(function(res) {
				$("textarea#textWriteLog").val("Resource created: " + JSON.stringify(resWrite.data,null,2) );
				console.log ( "Resource created: " + JSON.stringify(res.data,null,2) );
				window.def.resolve(res);            
			});

          		return window.def.resolve();
		}); //FHIR.oauth2.ready()
		
		return window.def.promise();

	}); // on("click #buttonWrite


	// 3 - Retrieve a particular resource for the Patient
	$(document).on("click", "#buttonResource", function(event){
		event.stopPropagation();

		console.log( "Retrieving a " + $("textarea#textResourceLog").val() + " resource" );

		// Preliminary step - Creating a deferred object for a set of enhancements to the way to use callbacks.
		//var def = $.Deferred();
		//def.done(function(){
		//	$("textarea#textResourceLog").append("====== DONE ======");
		//	console.log( "====== DONE SEARCH ======" );
		//});
		
		FHIR.oauth2.ready(function(smart){
		//function resourceSearch() {

			var resType = $("textarea#textResourceLog").val();
			$("textarea#textResourceLog").append( "Retrieving a " + resType + " resource" );
			
			smart.patient.api.search({type: resType}).done(function(res){
				$("textarea#textResourceLog").append( resType + ": " + JSON.stringify(res) );
				console.clear();
				console.log( resType + ": " + JSON.stringify(res,null,2) );

				// Resolve a Deferred object and call any doneCallbacks with the given args.
				window.def.resolve(res);
			});

          		return window.def.resolve();
		}); //FHIR.oauth2.ready()

		return window.def.promise();

	}); // on("click #buttonResource


	function onReady(smart) {
         
		// The instance of FHIR.client 
		$("textarea#textRetrieveLog").append("Smart: " + JSON.stringify(smart));
		console.log( "smart: " + JSON.stringify(smart,null,2) );
                    
		// 1. Retrieve patient in scope
		// This will return a patient object like this: {"id":"4342009","api":{}}
		var patient = smart.patient;
		$("textarea#textRetrieveLog").append("Patient from scope: " + JSON.stringify(patient));
		console.log( "Patient from scope: " + JSON.stringify(patient,null,2) );
          
		// 2. Obtaining the context
		// Once the client is initialized, you can obtain the context in which it was launched (the user who authorized the client and, if applicable, the patient that has been selected).
		// This returns a jQuery Deferred object which you can register a success callback to process the returned FHIR resource.
		smart.patient.read().then(function(pt) {
			$("textarea#textRetrieveLog").append("Patient from context: " + JSON.stringify(pt));
			console.log( "Patient from context: " + JSON.stringify(pt,null,2) );            
		});
	}; // onReady(smart)


	function onError(smart) {
		$("textarea#textRetrieveLog").append("Error: " + JSON.stringify(smart));
		console.log( "Error: " + JSON.stringify(smart,null,2) );
		console.log('FHIR.oauth2.ready(OnError)', arguments);
          
		return def.reject();
	} // onError()

    </script>
    
    
  </head>
  <body>

  <div class="grid" style="display:block;width:1200px;overflow:auto;margin:10px auto 0 auto;">
	<div class="pageColumnLeft" style="float:left;clear:none;width:400px;">
		<button id="buttonRetrieve">Retrieve Patient</button>
		<textarea id="textRetrieveLog" rows="35" cols="45">...</textarea>
	</div>
	<div class="pageColumnMid" style="float:left;clear:none;width:400px;">
		<button id="buttonWrite">Write a Resource</button>
		<textarea id="textWriteLog" rows="35" cols="45">...</textarea>
	</div>
	<div class="pageColumnRight" style="float:left;clear:none;width:400px;">
		<button id="buttonResource">Retrieve a Resource</button>
		<textarea id="textResourceLog" rows="35" cols="45">...</textarea>
	</div>
   </div>

  </body>
</html>
