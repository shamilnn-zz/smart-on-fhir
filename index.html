<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <title>11:14 TEST SMART APP</title>
    <link rel='stylesheet' type='text/css' href='./src/css/example-smart-app.css'>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>    
    <!-- <script src='./lib/es6-shim-0.35.1.min.js'></script> -->
    <!-- <script src='./src/js/example-smart-app.js'></script> -->
    <script src='./lib/fhir-client.js'></script>
    
    <script type="text/javascript">
      $( document ).ready(function(){
        console.log("URL: " + window.location.href);
      });
      
      $( window ).load(function() {
        
        $('.progress').append("<p> Started </p>");
        console.log( "Loading page..." );
        
        // Preliminary step - Creating a deferred object for a set of enhancements to the way to use callbacks.
        var def = $.Deferred();
        def.done(function(){
          $('.progress').append("<p> All done </p>");
          console.log( "All done" );
        });
        
        // 1. Initializing the client
        // Before you are able to run any operations against the FHIR API using the JS client, you will need to initialize it first.
        FHIR.oauth2.ready(onReady, onError);
        $('.progress').append("<p>" + "window.FHIR: " + JSON.stringify(window.FHIR) + "</p>");
        console.log( "window.FHIR: " + JSON.stringify(window.FHIR,null,2) );
        
        // The deferred.promise() method allows an asynchronous function to prevent other code from interfering with the 
        // progress or status of its internal request.
        $('.progress').append("<p> Completed </p>");
        console.log( "Completed" );
        return def.promise();
        
        
        function onReady(smart) {
         
          // 1. Retrieve patient in scope
          // This will return a patient object like this: {"id":"4342009","api":{}}
          var patient = smart.patient;
          $('.progress').append("<p>" + "Patient from scope: " + JSON.stringify(patient) + "</p>");
          console.log( "Patient from scope: " + JSON.stringify(patient,null,2) );
          
          // 2. Obtaining the context
          // Once the client is initialized, you can obtain the context in which it was launched (the user who authorized the client and, if applicable, the patient that has been selected).
          // This returns a jQuery Deferred object which you can register a success callback to process the returned FHIR resource.
          smart.patient.read().then(function(pt) {
            $('.progress').append("<p>" + "Patient from context: " + JSON.stringify(pt) + "</p>");
            console.log( "Patient from context: " + JSON.stringify(pt,null,2) );            
          });
          
          // 3. Fetch a resource
          // 4. Processing search results
          // This function return $.Deferred object, which you can work with simply by calling their done() method.
          // In the $.Deferred object's done() callback, you'll get a data structure containing search results.
          smart.patient.api.search({type: 'Observation'}).done(function(obs){
            $('.progress').append("<p>" + "Observation: " + JSON.stringify(obs) + "</p>");
             console.log( "Observation: " + JSON.stringify(obs,null,2) );
            
            var units = smart.units;
            console.log( "units: " + JSON.stringify(units) );
            
             // Trying byCode() function
            var byCodeFN = smart.byCodes(obs, '2085-9');
            console.log( "byCodes(): " + byCodeFN );
            
            var hdl = byCodeFN('2085-9');
            console.log( "HDL: " + JSON.stringify(hdl) );

            var height = byCodeFN('8302-2');
            console.log( "Height: " + JSON.stringify(height) );
            
             // Resolve a Deferred object and call any doneCallbacks with the given args.
             def.resolve(obs);
          });

          return def.resolve();
        } // End onRead()
        
        function onError(smart) {
          $('.progress').append("<p>" + "Error: " + JSON.stringify(smart) + "</p>");
          console.log( "Error: " + JSON.stringify(smart,null,2) );
          console.log('FHIR.oauth2.ready(OnError)', arguments);
          
          // When something goes wrong, you reject the deferred object using the reject method. You
          //can register callbacks functions for failed tasks using the fail method. The reject methods triggers
          //callbacks registered with the fail method in the same way that the resolve method triggers callbacks
          //registered with done.          
          return def.reject();
        } // End onError()

      });
    </script>
  </head>
  <body>
    <div id="loading" class="progress"></div>
  </body>
</html>
